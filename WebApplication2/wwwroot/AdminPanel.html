<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Panel administratora</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/site.css" rel="stylesheet">

    <style>
        /* Zapewnij wsparcie dla polskich znaków i emoji */
        body, .winter-button, .contact-item, .contact-value, .section-title, .msg {
            font-family: 'Segoe UI', Arial, 'Noto Color Emoji', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
        }

        .admin-grid {
            display: grid;
            gap: 1rem;
        }

        .two-col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: .75rem;
        }

        .msg {
            margin-top: .5rem;
            font-size: .95rem;
        }

            .msg.error {
                color: #ff6b6b;
            }

            .msg.success {
                color: #2ecc71;
            }

        .logs-box {
            margin-top: 1rem;
        }

        .logs-item {
            padding: .45rem .6rem;
            border-bottom: 1px solid rgba(255,255,255,.15);
        }

            .logs-item .lvl {
                font-weight: 700;
                margin-right: .4rem;
            }

            .logs-item.error .lvl {
                color: #ff6b6b;
            }

            .logs-item.warn .lvl {
                color: #ffd166;
            }

            .logs-item.info .lvl {
                color: #4dabff;
            }

        .delete-box {
            margin-top: 1.2rem;
        }
    </style>
</head>

<body>
    <div class="buttons-top-right">
        <button class="winter-button" type="button" data-nav="Index.html">❆ Menu</button>
        <button class="winter-button" type="button" data-nav="Equipment.html">⛷️ Sprzęt</button>

        <details class="user-panel disabled">
            <summary class="winter-button" aria-label="Panel użytkownika">👤 Panel użytkownika</summary>
            <div class="user-panel-menu">
                <button class="winter-button" type="button" data-nav="OrderHistory.html" data-show-when-auth="true">Historia zamówień</button>
                <button class="winter-button" type="button" data-nav="UserData.html" data-show-when-auth="true">Dane użytkownika</button>
                <button class="winter-button" type="button" data-nav="WorkerPanel.html" data-required-roles="worker, admin">Panel pracownika</button>
                <button class="winter-button" type="button" data-nav="AdminPanel.html" data-required-roles="admin">Panel administratora</button>
                <button class="winter-button" type="button" data-nav="AddOrDeleteItem.html" data-required-roles="worker, admin">Dodaj Sprzęt</button>
            </div>
        </details>

        <button class="winter-button" type="button" data-nav="Kontakt.html">📞 Kontakt</button>
        <button class="winter-button" type="button" data-nav="Login.html" data-hide-when-auth="true">🔒 Logowanie</button>
        <button class="winter-button" type="button" data-logout="true" data-show-when-auth="true">🚪 Wyloguj</button>
    </div>

    <div class="content-section">
        <div class="frost-effect admin-grid">
            <h1 class="winter-title">Panel administratora</h1>

            <!-- Dodawanie pracownika -->
            <div class="form-box">
                <h2 class="section-title" style="text-align:center;">➕ Dodaj pracownika</h2>

                <form id="workerForm" novalidate>
                    <div class="two-col">
                        <label>
                            Imię
                            <input type="text" name="FirstName" required />
                        </label>
                        <label>
                            Nazwisko
                            <input type="text" name="LastName" required />
                        </label>
                        <label>
                            Email
                            <input type="email" name="Email" required />
                        </label>
                        <label>
                            Telefon (9 cyfr)
                            <input type="text" name="PhoneNumber" maxlength="9" pattern="\d{9}" required />
                        </label>
                        <label>
                            Stanowisko (Job_Title)
                            <input type="text" name="Job_Title" required />
                        </label>
                        <label>
                            Hasło (min.6)
                            <input type="password" name="Password" minlength="6" required />
                        </label>
                        <label>
                            Adres (opcjonalnie)
                            <input type="text" name="Address" />
                        </label>
                        <label>
                            Dni pracy (np. Mon-Fri)
                            <input type="text" name="Working_Days" />
                        </label>
                        <label>
                            Start pracy
                            <input type="time" name="WorkStart" value="08:00" required />
                        </label>
                        <label>
                            Koniec pracy
                            <input type="time" name="WorkEnd" value="16:00" required />
                        </label>
                    </div>

                    <div class="block-actions" style="margin-top:.5rem;">
                        <button class="winter-button" type="submit">Utwórz pracownika</button>
                    </div>

                    <div id="workerMsg" class="msg"></div>
                </form>
            </div>

            <!-- Usuwanie użytkownika -->
            <div class="form-box delete-box">
                <h2 class="section-title" style="text-align:center;">🗑️ Usuń użytkownika / pracownika</h2>

                <form id="deleteForm" novalidate style="width:100%;">
                    <label>
                        Email do usunięcia
                        <input type="email" name="DelEmail" id="delEmail" required placeholder="np. jan@firma.com" />
                    </label>

                    <div class="block-actions" style="margin-top:.6rem;">
                        <button class="winter-button danger" type="submit">Usuń</button>
                    </div>

                    <div id="deleteMsg" class="msg"></div>
                </form>
            </div>

            <!-- Logi -->
            <div class="form-box logs-box" data-required-roles="admin">
                <h2 class="section-title" style="text-align:center;">📜 Logi systemowe</h2>

                <div class="two-col">
                    <label>
                        Filtr poziomu
                        <select id="logLevel">
                            <option value="">(wszystkie)</option>
                            <option value="Information">Informacja</option>
                            <option value="Warning">Ostrzeżenie</option>
                            <option value="Error">Błąd</option>
                        </select>
                    </label>

                    <label>
                        Tekst
                        <input type="text" id="logText" />
                    </label>
                </div>

                <div class="block-actions">
                    <button class="winter-button" id="reloadLogs">Odśwież</button>
                </div>

                <div id="logsList"></div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="/js/site.js" defer></script>

    <script>
        (async function () {
            function waitForAuth() {
                return new Promise(r => {
                    if (window.auth) return r();
                    let i = 0;
                    const t = setInterval(() => {
                        i++;
                        if (window.auth || i > 50) {
                            clearInterval(t);
                            r();
                        }
                    }, 50);
                });
            }

            await waitForAuth();
            if (!window.auth || !window.auth.hasAnyRole('Admin')) {
                window.location.href = 'Login.html';
                return;
            }

            const msg = document.getElementById('workerMsg');
            const delMsg = document.getElementById('deleteMsg');

            function toHHmmss(v) {
                if (!v) return '00:00:00';
                const p = String(v).split(':');
                if (p.length === 2) return p[0].padStart(2, '0') + ':' + p[1].padStart(2, '0') + ':00';
                return (p[0] || '00').padStart(2, '0') + ':' + (p[1] || '00').padStart(2, '0') + ':' + (p[2] || '00').padStart(2, '0');
            }

            function formToObj(form) {
                const obj = {};
                new FormData(form).forEach((v, k) => obj[k] = v);
                return obj;
            }

            async function postJson(url, body) {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });

                const txt = await res.text();
                let data = txt;
                try { data = JSON.parse(txt); } catch { }

                if (!res.ok) throw new Error(typeof data === 'string' ? data : (data.Message || JSON.stringify(data)));
                return data;
            }

            async function deleteByEmail(email) {
                const res = await fetch('/api/Workers/' + encodeURIComponent(email), {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const txt = await res.text();
                let data = txt;
                try { data = JSON.parse(txt); } catch { }

                if (!res.ok) throw new Error(typeof data === 'string' ? data : (data.Message || JSON.stringify(data)));
                return data;
            }

            // Pobieranie pierwszego RentalInfo ID
            let defaultRentalId = null;
            try {
                const res = await fetch('/api/RentalInfo', { credentials: 'include' });
                if (res.ok) {
                    const list = await res.json();
                    if (Array.isArray(list) && list.length) {
                        defaultRentalId = list[0].id || list[0].Id;
                    }
                }
            } catch { }

            // Tworzenie pracownika
            document.getElementById('workerForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                msg.className = 'msg';
                msg.textContent = 'Tworzenie pracownika...';

                const raw = formToObj(e.target);
                const payload = {
                    FirstName: raw.FirstName?.trim(),
                    LastName: raw.LastName?.trim(),
                    Email: raw.Email?.trim(),
                    PhoneNumber: raw.PhoneNumber?.trim(),
                    Address: raw.Address?.trim() || null,
                    WorkStart: toHHmmss(raw.WorkStart),
                    WorkEnd: toHHmmss(raw.WorkEnd),
                    Working_Days: raw.Working_Days?.trim() || null,
                    Job_Title: raw.Job_Title?.trim(),
                    Password: raw.Password
                };

                if (defaultRentalId) payload.RentalInfoId = defaultRentalId;

                try {
                    const res = await postJson('/api/Workers', payload);
                    msg.className = 'msg success';
                    msg.textContent = 'Utworzono pracownika. UserId: ' + (res.UserId || '') + ', WorkerId: ' + (res.WorkerId || '');

                    e.target.reset();
                } catch (err) {
                    msg.className = 'msg error';
                    msg.textContent = 'Błąd: ' + err.message;
                }
            });

            // Usuwanie pracownika
            document.getElementById('deleteForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                delMsg.className = 'msg';
                delMsg.textContent = 'Usuwanie...';

                const email = document.getElementById('delEmail').value.trim();
                if (!email) {
                    delMsg.className = 'msg error';
                    delMsg.textContent = 'Podaj email';
                    return;
                }

                try {
                    const res = await deleteByEmail(email);
                    delMsg.className = 'msg success';
                    delMsg.textContent = 'Usunięto: ' + (res.Email || email);

                    e.target.reset();
                } catch (err) {
                    delMsg.className = 'msg error';
                    delMsg.textContent = 'Błąd: ' + err.message;
                }
            });

            // Logi
            async function loadLogs() {
                const lvl = document.getElementById('logLevel').value;
                const txt = document.getElementById('logText').value.trim();

                const url = new URL('/api/logs', location.origin);
                if (lvl) url.searchParams.set('level', lvl);
                if (txt) url.searchParams.set('text', txt);

                const res = await fetch(url, { credentials: 'include' });
                if (!res.ok) return;

                const list = await res.json();
                const host = document.getElementById('logsList');

                host.innerHTML = Array.isArray(list) && list.length
                    ? list.map(l => {
                        const cls = (l.Level || '').toLowerCase();
                        const ts = l.Timestamp ? new Date(l.Timestamp).toLocaleString('pl-PL') : '';
                        const user = l.UserId || '';

                        return `
                                <div class="logs-item ${cls}">
                                    <span class="lvl">${l.Level}</span>
                                    <span>${ts}</span>
                                    <div><strong>${l.Scope || ''}</strong> — ${l.Message || ''}</div>
                                    ${user ? `<div>Użytkownik: ${user}</div>` : ''}
                                </div>
                            `;
                    }).join('')
                    : '<div class="contact-item">Brak wpisów.</div>';
            }

            document.getElementById('reloadLogs').addEventListener('click', loadLogs);
            loadLogs();

        })();
    </script>

</body>
</html>
